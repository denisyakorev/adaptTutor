<!DOCTYPE html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<%

function test_main(){
    var src = 'C:\\Program Files\\WebSoft\\WebTutorServer\\wt\\web\\adaptTutor\\project\\tests\\download.zip';
    var data = 'course_path='+src;
    var address = 'http://localhost/adaptTutor/endpoint.html';
    HttpRequest(address, 'post', data);

    var module = ArrayOptFirstElem(XQuery('for $elem in course_modules where $elem/name="Course title" return $elem'));
    if (module == undefined) {
        %><h1>Тест 1 не пройден</h1><%
    }

    var course = ArrayOptFirstElem(XQuery('for $elem in courses where $elem/name="Course title" return $elem'));
    if (course == undefined) {
        %><h1>Тест 2 не пройден</h1><%
        return;
    }

    var course_doc = OpenDoc(UrlFromDocID(Int(course.id)));
    if(course_doc.TopElem.parts[0].course_module_id != Int(course_module_id)){
        %><h1>Тест 3 не пройден</h1><%
    }

    DeleteDoc(UrlFromDocID(Int(course.id)));
    DeleteDoc(UrlFromDocID(Int(module.id)));
}


function test_unzip_course(){
    var src = 'C:\\Program Files\\WebSoft\\WebTutorServer\\wt\\web\\adaptTutor\\project\\tests\\download.zip';
    var adapt_lib = OpenCodeLib('../../adapt_lib.js');
    var new_path = adapt_lib.unzip_course(src);

    if(new_path == ""){
        %><h1>Тест 4 не пройден</h1><%
        return;
    }
    
    if(!FilePathExists(UrlToFilePath(new_path))){
        %><h1>Тест 5 не пройден</h1><%
        return;
    }
    if(!FilePathExists(UrlToFilePath(new_path)+"\\imsmanifest.xml")){
        %><h1>Тест 6 не пройден</h1><%
        return;
    }

    DeleteDirectory(UrlToFilePath(new_path));
}


function test_create_module(){
    var src = 'C:\\Program Files\\WebSoft\\WebTutorServer\\wt\\web\\adaptTutor\\project\\tests\\download.zip';
    var adapt_lib = OpenCodeLib('../../adapt_lib.js');
    var new_path = adapt_lib.unzip_course(src);

    adapt_lib.create_module(new_path);
    var module = ArrayOptFirstElem(XQuery('for $elem in course_modules where $elem/name="Course title" return $elem'));
    if (module == undefined) {
        %><h1>Тест 7 не пройден</h1><%
        return;
    }
    if (module.url != StrReplace(new_path, 'x-local://wt/web/webtutor/', '')){
        %><h1>Тест 8 не пройден</h1><%
    }
    if (module.set_status_side != 'course'){
        %><h1>Тест 9 не пройден</h1><%
    }

}

function test_get_code_from_path(){
    var adapt_lib = OpenCodeLib('../../adapt_lib.js');
    var code1 = adapt_lib.get_code_from_path('');
    if(code1 != ''){
        %><h1>Тест 10 не пройден</h1><%
    }
    var code2 = adapt_lib.get_code_from_path('\\asdfa\\asdfasdfdafasdfas\\123\\download.zip');
    if(code2 != '123'){
        %><h1>Тест 11 не пройден. <%=code2%> вместо 123</h1><%
    }
    var code3 = adapt_lib.get_code_from_path('\\asdfa\\asdfasdfdafasdfas\\123');
    if(code3 != ''){
        %><h1>Тест 12 не пройден</h1><%
    }
}


function test_get_module_data(){
    var adapt_lib = OpenCodeLib('../../adapt_lib.js');
    var code1 = adapt_lib.get_module_data('x-local://wt/web/adaptTutor/project/tests/imsmanifest.xml');
    if(code1 != 'Course title'){
        %><h1>Тест 13 не пройден</h1><%
    }
    var code2 = adapt_lib.get_module_data('C:\\Program Files\\WebSoft\\WebTutorServer\\wt\\web\\adaptTutor\\project\\tests\\imsmanifest2.xml');
    if(code2 != 'Course title2'){
        %><h1>Тест 14 не пройден</h1><%
    }
}

test_main();
test_unzip_course();
test_create_module();
test_get_code_from_path();
test_get_module_data();

%>